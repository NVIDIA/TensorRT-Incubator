from tripy import utils
from tripy.backend.mlir.mlir import mlir_wrapper, void_ptr
from tripy.common.logging import logger
from tripy.backend.mlir.utils import remove_constants


class Compiler:
    def __init__(self) -> None:
        self.compiler = mlir_wrapper()

    def compile_stabehlo_program(self, stablehlo_program: str) -> void_ptr:
        return self.compiler.compile(stablehlo_program)

    @utils.log_time
    def compile(self, mlir) -> void_ptr:
        """
        Compiles an MLIR module into an MLIR-TRT executable

        Args:
            mlir: The MLIR module.

        Returns:
            Pointer to the executable generated by the mlir-tensorrt compiler.
        """
        mlir_textual = str(mlir)
        logger.mlir(lambda: f"{utils.prefix_with_line_numbers(remove_constants(mlir_textual))}\n")
        return self.compile_stabehlo_program(mlir_textual)
