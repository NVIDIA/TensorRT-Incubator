

<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="docsearch:name" content="Tripy" />
    <meta name="docsearch:package_type" content="" />
    <meta name="docsearch:release" content="0.0.1" />
    <meta name="docsearch:version" content="0.0.1" />
    
      <title>Design Decisions &mdash; Tripy 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/bootstrap-icons.css" type="text/css" />
          <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=3d3fbe02" />
          <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
          <link id="pygments_dark_css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css" href="../../_static/pygments_dark.css?v=b20cc3f5" />
          <link rel="stylesheet" type="text/css" href="../../_static/colorsets/sphinx-nefertiti-green.min.css" />
          <link rel="stylesheet" type="text/css" href="../../_static/fonts/nunito/stylesheet.css" />
          <link rel="stylesheet" type="text/css" href="../../_static/fonts/red-hat-mono/stylesheet.css" />
          <link rel="stylesheet" type="text/css" href="../../_static/pygments_dark.css?v=b20cc3f5" />
          <link rel="stylesheet" type="text/css" href="../../_static/style.css?v=270043a8" />
        <link rel="index" title="Index" href="../../genindex.html" />
        <link rel="search" title="Search" href="../../search.html" />
        <link rel="top" title="Tripy 0.0.1 documentation" href="#" />
    <style>
      :root {
        --nftt-body-font-family: "Nunito", var(--nftt-font-sans-serif) !important;
        --nftt-font-monospace: "Red Hat Mono", var(--nftt-font-family-monospace) !important;
        --nftt-project-name-font: var(--nftt-body-font-family);
        --nftt-documentation-font: var(--nftt-body-font-family);
        --nftt-doc-headers-font: "Georgia", var(--nftt-documentation-font);--nftt-documentation-font-size: 1.0rem;--nftt-monospace-font-size: 0.85rem;}
      h1 *, h2 *, h3 *, h4 *, h5 *, h6 * { font-size: inherit; }
    </style>
  </head>
  <body>
    <header class="navbar navbar-expand-lg navbar-dark nftt-navbar flex-column fixed-top">
      <div class="skip-links container-xxl visually-hidden-focusable overflow-hidden justify-content-start">
        <div class="border-bottom mb-2 pb-2 w-100">
          <a class="d-none d-md-inline-flex p-2 m-1" href="#sidebar-filter">Skip to docs navigation</a>
          <a class="d-inline-flex p-2 m-1" href="#content">Skip to main content</a>
        </div>
      </div>
      <nav class="container-xxl nftt-gutter flex-wrap flex-lg-nowrap" aria-label="Main navigation">
        <div class="nftt-navbar-toggler">
          <button class="navbar-toggler p-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar" aria-label="Toggle documentation navigation">
            <i class="bi bi-list"></i>
          </button>
        </div>
          <a href="../../index.html"
              
              class="navbar-brand p-0 me-0 md-lg-2"
          ><span class="brand-text">Tripy</span></a>
        
        <div class="d-flex d-lg-none">
          <button class="navbar-toggler p-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#nfttSearch" aria-controls="nfttSearch" aria-label="Search">
            <i class="bi bi-search"></i>
          </button>
          <button class="navbar-toggler p-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#nfttNavbar" aria-controls="nfttNavbar" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
        </div>
        
<div class="offcanvas-lg offcanvas-end flex-grow-1" tabindex="-1" id="nfttSearch" aria-labelledby="nfttSearchOffcanvasLabel" data-bs-scroll="true">
  <div class="offcanvas-header px-4 pb-0">
    <h5 class="offcanvas-title fw-bold" id="nfttSearchOffcanvasLabel">Search the documentation</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close" data-bs-target="#nfttSearch"></button>
  </div>
  <div class="offcanvas-body p-4 pt-0 p-lg-0 px-lg-3">
    <hr class="d-lg-none text-white-50">
    <ul class="navbar-nav flex-row align-items-center flex-wrap ms-md-auto">
      <li class="nav-item col-12 col-lg-auto">
        <form id="nftt-search-form" action="../../search.html" method="get">
          <div class="input-group">
            <input type="text" name="q" class="form-control" placeholder="Search docs" aria-label="Search" aria-describedby="button-search">
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
            <button class="btn btn-primary" type="submit" id="button-search" aria-label="Search"><i class="bi bi-search"></i></button>
          </div>
        </form>
      </li>
    </ul>
  </div>
</div>

        <div class="offcanvas-lg offcanvas-end" tabindex="-1" id="nfttNavbar" aria-labelledby="nfttNavbarOffcanvasLabel" data-bs-scroll="true">
          <div class="offcanvas-header px-4 pb-0">
            <div class="offcanvas-title text-white fw-bold" id="nfttNavbarOffcanvasLabel"><span class="brand-text">Nefertiti for Sphinx</span></div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close" data-bs-target="#nfttNavbar"></button>
          </div>
          <div class="offcanvas-body p-4 pt-0 p-lg-0">
            <hr class="d-lg-none text-white-50">
            <ul class="navbar-nav flex-row align-items-center flex-wrap ms-md-auto">
              
              <li class="nav-item col-12 col-lg-auto">
                <a class="nav-link py-2 py-lg-0 px-0 px-lg-2" href="https://github.com/NVIDIA/TensorRT-Incubator" target="_blank" rel="noopener">
                  <div class="d-flex align-items-center">
                    <div class="me-2">
                      <i class="bi bi-git size-24"></i>
                    </div>
                    <div class="repo d-flex flex-column align-items-center" data-snftt-repo-url="https://github.com/NVIDIA/TensorRT-Incubator">
                      Tripy
                      <div class="d-flex justify-content-center" data-snftt-repo-metrics>
                        <span class="pe-2 d-flex justify-content-center align-items-center">
                          <i class="bi bi-tag size-14"></i>
                          <span class="repo-metric" data-snftt-repo-tag></span>
                        </span>
                        <span class="pe-2 d-flex justify-content-center align-items-center">
                          <i class="bi bi-star size-14"></i>
                          <span class="repo-metric" data-snftt-repo-stars></span>
                        </span>
                        <span class="d-flex justify-content-center align-items-center">
                          <i class="bi bi-diagram-2 size-14"></i>
                          <span class="repo-metric" data-snftt-repo-forks></span>
                        </span>
                      </div>
                    </div>
                  </div>
                </a>
              </li>
              <li class="nav-item col-12 col-lg-auto h-100" aria-hidden="true">
                <div class="vr d-none d-lg-flex h-100 mx-lg-2 text-white"></div>
                <hr class="d-lg-none text-white-50">
              </li>
              
              <!-- version_dropdown.html -->

              
              <!-- colorscheme_dropdown.html -->
<li class="nav-item dropdown">
  <a class="nav-link d-flex py-2 px-0 px-lg-2 dropdown-toggle align-items-center" id="snftt-luz" href="#" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false" aria-label="Toggle light/dark">
    <i class="bi bi-circle-half" data-snftt-luz-icon-active></i>
    <span id="snftt-luz-text" class="d-lg-none small ms-2">Toggle light/dark</span>
  </a>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="snftt-luz-text">
    <li>
      <h6 class="dropdown-header">Light/dark</h6>
    </li>
    <li>
      <a class="dropdown-item d-flex align-items-center" data-snftt-luz="light" href="#" aria-pressed="false">
        <span class="small">
          <i class="bi bi-sun" data-snftt-luz-icon="light"></i>
        </span>
        <span class="small ms-3">Light</span>
        <i class="bi bi-check ms-auto"></i>
      </a>
    </li>
    <li>
      <a class="dropdown-item d-flex align-items-center" data-snftt-luz="dark" href="#" aria-pressed="false">
        <span class="small">
          <i class="bi bi-moon-stars" data-snftt-luz-icon="dark"></i>
        </span>
        <span class="small ms-3">Dark</span>
        <i class="bi bi-check ms-auto"></i>
      </a>
    </li>
    <li>
      <a class="dropdown-item current d-flex align-items-center" data-snftt-luz="default" href="#" aria-pressed="false">
        <span class="small">
          <i class="bi bi-circle-half" data-snftt-luz-icon="default"></i>
        </span>
        <span class="small ms-3">Default</span>
        <i class="bi bi-check ms-auto"></i>
      </a>
    </li>
  </ul>
</li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <div class="container-xxl nftt-gutter nftt-layout">
      <aside class="nftt-sidebar">
        <div class="title d-none d-md-block">
          <i class="bi bi-book"></i>&nbsp;&nbsp;<span>Table of contents</span>
        </div>
        <div id="sidebar" tabindex="-1" class="offcanvas-lg offcanvas-start" aria-labelledby="nfttSidebarOffcanvasLabel">
            <!-- danirus sidebartemplate: "globaltoc.html" --><div class="offcanvas-header border-bottom">
  <h5 class="offcanvas-title" id="nfttSidebarOffcanvasLabel">
    Table of contents
  </h5>
  <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close" data-bs-target="#sidebar"></button>
</div>

<div class="offcanvas-body">
  <nav class="toc" aria-label="Main menu">
    <div class="mb-3 p-1 pt-3 pb-4 border-bottom">
      <input id="sidebar-filter" type="text" name="filter" class="form-control form-control-sm" placeholder="filter" aria-label="filter">
    </div>
    <p class="caption" role="heading"><span class="caption-text">User Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../pre0_user_guides/00-introduction-to-tripy.html">An Introduction To Tripy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pre0_user_guides/01-quantization.html">Quantization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../compiler/index.html">Compiler</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../compiler/arg_info.html">ArgInfo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../compiler/executable.html">Executable</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../compiler/input_info.html">InputInfo</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../config.html">config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../datatype.html">dtype</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../device.html">device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exception/index.html">Exception</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../exception/tripy_exception.html">TripyException</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../logger.html">logger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/index.html">Module</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../modules/parameter.html">Parameter</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../operations/index.html">Operations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../operations/functions/index.html">Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/abs.html">abs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/all.html">all</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/allclose.html">allclose</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/any.html">any</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/argmax.html">argmax</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/argmin.html">argmin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/cast.html">cast</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/concatenate.html">concatenate</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/copy.html">copy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/cos.html">cos</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/exp.html">exp</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/expand.html">expand</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/flip.html">flip</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/gather.html">gather</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/gelu.html">gelu</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/log.html">log</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/masked_fill.html">masked_fill</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/max.html">max</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/maximum.html">maximum</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/mean.html">mean</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/minimum.html">minimum</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/permute.html">permute</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/plugin.html">plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/prod.html">prod</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/relu.html">relu</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/reshape.html">reshape</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/rsqrt.html">rsqrt</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/sigmoid.html">sigmoid</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/silu.html">silu</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/sin.html">sin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/softmax.html">softmax</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/split.html">split</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/sqrt.html">sqrt</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/squeeze.html">squeeze</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/sum.html">sum</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/tanh.html">tanh</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/transpose.html">transpose</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/unsqueeze.html">unsqueeze</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/var.html">var</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/functions/where.html">where</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/initializers/index.html">Initializers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../operations/initializers/arange.html">arange</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/initializers/full.html">full</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/initializers/full_like.html">full_like</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/initializers/iota.html">iota</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/initializers/iota_like.html">iota_like</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/initializers/ones.html">ones</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/initializers/ones_like.html">ones_like</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/initializers/tril.html">tril</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/initializers/triu.html">triu</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/initializers/zeros.html">zeros</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/initializers/zeros_like.html">zeros_like</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/modules/index.html">Modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../operations/modules/conv.html">Conv</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/modules/conv_transpose.html">ConvTranspose</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/modules/embedding.html">Embedding</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/modules/group_norm.html">GroupNorm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/modules/layer_norm.html">LayerNorm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/modules/linear.html">Linear</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/quantization/index.html">Quantization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../operations/quantization/dequantize.html">dequantize</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/quantization/quantize.html">quantize</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../shape.html">Shape</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tensor/index.html">Tensor</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../post0_developer_guides/architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../post0_developer_guides/debugging.html">Debugging MLIR-TensorRT backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../post0_developer_guides/design-decisions.html">Design Decisions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../post0_developer_guides/how-to-add-new-ops.html">Adding New Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../post0_developer_guides/mlir-dialect-python-apis.html">Using Python APIs of MLIR Dialects</a></li>
</ul>

  </nav>
  <template data-toggle-item-template>
    <button class="btn btn-sm btn-link toctree-expand" type="button">
      <i class="bi bi-caret-right"></i>
      <span class="visually-hidden">Toggle menu contents</span>
    </button>
  </template>
</div>
        </div>
      </aside>
      <main class="nftt-main">
        <article id="content" class="nftt-content" role="main">
    <section id="design-decisions">
<h1><a class="toc-backref" href="#id1" role="doc-backlink">Design Decisions</a><a class="headerlink" href="#design-decisions" title="Link to this heading">¶</a></h1>
<p>This document outlines some of the design decisions we’ve made and explains why they
were chosen over alternatives.</p>
<nav class="contents" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#design-decisions" id="id1">Design Decisions</a></p>
<ul>
<li><p><a class="reference internal" href="#no-api-redundancy" id="id2">No API Redundancy</a></p></li>
<li><p><a class="reference internal" href="#why-flatir" id="id3">Why <code class="docutils literal notranslate"><span class="pre">FlatIR</span></code>?</a></p></li>
<li><p><a class="reference internal" href="#why-does-to-flat-ir-rely-on-binding-to-input-output-tensors" id="id4">Why Does <code class="docutils literal notranslate"><span class="pre">to_flat_ir()</span></code> Rely On Binding To Input/Output Tensors?</a></p>
<ul>
<li><p><a class="reference internal" href="#alternative-1-returning-operators" id="id5">Alternative 1: Returning Operators</a></p></li>
<li><p><a class="reference internal" href="#alternative-2-functional-apis" id="id6">Alternative 2: Functional APIs</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#why-is-baseflatirop-to-mlir-asymmetric-with-basetraceop-to-flat-ir" id="id7">Why Is <code class="docutils literal notranslate"><span class="pre">BaseFlatIROp.to_mlir()</span></code> Asymmetric With <code class="docutils literal notranslate"><span class="pre">BaseTraceOp.to_flat_ir()</span></code>?</a></p></li>
<li><p><a class="reference internal" href="#why-not-build-on-jax" id="id8">Why Not Build On JAX?</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="no-api-redundancy">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">No API Redundancy</a><a class="headerlink" href="#no-api-redundancy" title="Link to this heading">¶</a></h2>
<p>One way we deviate from frameworks like PyTorch is that our API only provides one way to do things.
For example, in PyTorch, <code class="docutils literal notranslate"><span class="pre">softmax</span></code> is exposed as <code class="docutils literal notranslate"><span class="pre">torch.softmax</span></code>, <code class="docutils literal notranslate"><span class="pre">torch.nn.functional.softmax</span></code>,
<code class="docutils literal notranslate"><span class="pre">torch.Tensor.softmax</span></code>, <code class="docutils literal notranslate"><span class="pre">torch.nn.Softmax</span></code>, etc. All of these are functionally identical and unnecessarily
increase the API surface. In Tripy, we only expose <code class="docutils literal notranslate"><span class="pre">tripy.softmax</span></code>. Trying to use anything else will
result in a (helpful) error message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">tp</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">softmax</span>
<span class="gp">...</span>
<span class="go">AttributeError: Module: &#39;tripy.Tensor&#39; does not have attribute: &#39;softmax&#39;. Did you mean: &#39;tripy.softmax&#39;?</span>
</pre></div>
</div>
</section>
<section id="why-flatir">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Why <code class="docutils literal notranslate"><span class="pre">FlatIR</span></code>?</a><a class="headerlink" href="#why-flatir" title="Link to this heading">¶</a></h2>
<p>In a previous version of Tripy, we used to map <code class="docutils literal notranslate"><span class="pre">Trace</span></code> operators directly to MLIR
operators. We eventually realized this was creating a lot of code duplication and had two
options:</p>
<ol class="arabic simple">
<li><p>Refactor common code into helper methods that can be shared across <code class="docutils literal notranslate"><span class="pre">Trace</span></code> operators.</p></li>
<li><p>Introduce another IR between <code class="docutils literal notranslate"><span class="pre">Trace</span></code> and MLIR that would handle the complexity.</p></li>
</ol>
<p>(2) is effectively a more organized form of (1). The <code class="docutils literal notranslate"><span class="pre">FlatIR</span></code> is essentially a usability layer
on top of MLIR but has the added benefit that we can inspect and modify the IR without
resorting to the poorly documented (as of this writing), MLIR Python APIs.</p>
</section>
<section id="why-does-to-flat-ir-rely-on-binding-to-input-output-tensors">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Why Does <code class="docutils literal notranslate"><span class="pre">to_flat_ir()</span></code> Rely On Binding To Input/Output Tensors?</a><a class="headerlink" href="#why-does-to-flat-ir-rely-on-binding-to-input-output-tensors" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">to_flat_ir()</span></code> method of <code class="docutils literal notranslate"><span class="pre">Trace</span></code> operators generates a subgraph and binds it
to the <code class="docutils literal notranslate"><span class="pre">inputs</span></code> and <code class="docutils literal notranslate"><span class="pre">outputs</span></code> parameters.
For example:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">def</span> <span class="nf">to_flat_ir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="kn">from</span> <span class="nn">tripy.flat_ir.ops</span> <span class="kn">import</span> <span class="n">TanhOp</span>
<span class="linenos">3</span>
<span class="linenos">4</span>    <span class="n">TanhOp</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
</pre></div>
</div>
<section id="alternative-1-returning-operators">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Alternative 1: Returning Operators</a><a class="headerlink" href="#alternative-1-returning-operators" title="Link to this heading">¶</a></h3>
<p>In a previous version of Tripy, we would return a list of operators that we wanted in the
<code class="docutils literal notranslate"><span class="pre">FlatIR</span></code> subgraph. Our example code would have looked something like this:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">def</span> <span class="nf">to_flat_ir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="kn">from</span> <span class="nn">tripy.flat_ir.ops</span> <span class="kn">import</span> <span class="n">TanhOp</span>
<span class="linenos">3</span>
<span class="linenos">4</span>    <span class="n">tanh</span> <span class="o">=</span> <span class="n">TanhOp</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
<span class="linenos">5</span>    <span class="k">return</span> <span class="p">[</span><span class="n">tanh</span><span class="p">]</span>
</pre></div>
</div>
<p>This seems perfectly fine for small cases like this and indeed is the reason that we initially
did it this way. However, for large subgraphs, it quickly becomes error-prone. It is too easy
to forget to include some <code class="docutils literal notranslate"><span class="pre">FlatIR</span></code> operations and that can lead to confusing bugs.</p>
<p>Since you never create a <code class="docutils literal notranslate"><span class="pre">FlatIR</span></code> operation in <code class="docutils literal notranslate"><span class="pre">to_flat_ir()</span></code> that you <em>don’t</em> want to be
part of the subgraph, we decided to make the <code class="docutils literal notranslate"><span class="pre">build()</span></code> function the single
source of truth for which operations are defined in the subgraph.</p>
</section>
<section id="alternative-2-functional-apis">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Alternative 2: Functional APIs</a><a class="headerlink" href="#alternative-2-functional-apis" title="Link to this heading">¶</a></h3>
<p>Another possibility would have been to provide functional APIs which would let us more easily
build up the FlatIR subgraph. Then our example code could have been implemented like so:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">def</span> <span class="nf">to_flat_ir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="k">return</span> <span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>This is clearly a nicer interface, but would require us to maintain another set of APIs.
We concluded that this would require too much effort and maintenance overhead.</p>
</section>
</section>
<section id="why-is-baseflatirop-to-mlir-asymmetric-with-basetraceop-to-flat-ir">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Why Is <code class="docutils literal notranslate"><span class="pre">BaseFlatIROp.to_mlir()</span></code> Asymmetric With <code class="docutils literal notranslate"><span class="pre">BaseTraceOp.to_flat_ir()</span></code>?</a><a class="headerlink" href="#why-is-baseflatirop-to-mlir-asymmetric-with-basetraceop-to-flat-ir" title="Link to this heading">¶</a></h2>
<p>In <code class="docutils literal notranslate"><span class="pre">to_flat_ir()</span></code>, the input and output <code class="docutils literal notranslate"><span class="pre">FlatIRTensor</span></code>s are created by the caller and
the operator that implements <code class="docutils literal notranslate"><span class="pre">to_flat_ir()</span></code> is responsible for creating a <code class="docutils literal notranslate"><span class="pre">FlatIR</span></code> subgraph
that binds to these input and output tensors.</p>
<p>However, in <code class="docutils literal notranslate"><span class="pre">to_mlir()</span></code>, we only pass in the input tensors. The reason for the asymmetry is
that some MLIR operators create their own output tensors whereas others need to bind to
existing ones. Due to this, we leave it to the <code class="docutils literal notranslate"><span class="pre">FlatIR</span></code> operator to convert its own outputs
to MLIR if needed or return the newly created ones.</p>
</section>
<section id="why-not-build-on-jax">
<h2>Why Not Build On <a class="reference external" href="https://github.com/google/jax">JAX</a>?<a class="headerlink" href="#why-not-build-on-jax" title="Link to this heading">¶</a></h2>
<p>Tripy’s architecture looks very similar to JAX’s, where python code is staged out and
lowered into a custom IR and eventually to MLIR.</p>
<p>Then why not build on top of JAX? There are a couple reasons:</p>
<ol class="arabic simple">
<li><p>JAX (Just Another XLA) is tightly coupled with XLA, which has a different set of limitations
and constraints than TensorRT. We do not want to inherit those limitations unnecessarily.</p></li>
<li><p>Using any components from JAX (e.g. the frontend, <code class="docutils literal notranslate"><span class="pre">LAX</span></code>, etc.) would create logistical
challenges and introduce latency in building/shipping Tripy.
By building our own stack, we control our destiny and can ship on our own schedule
without any dependency on external ecosystems.</p></li>
</ol>
<p>Building our own stack has a few other advantages:</p>
<ol class="arabic">
<li><p>We can provide first-class APIs for concepts specific to TensorRT, like optimization profiles.</p></li>
<li><p>Since we control the IR lowering logic, we can apply annotations that, for example, make it
easier to understand why certain transformations were performed or why new operations were
inserted.</p></li>
<li><p>We can augment error messages generated from anywhere in the stack with information
from the entire stack - all the way from the Python frontend down to the compiler.</p>
<p>Here’s an example of an error emitted from MLIR-TRT due to an operation inserted
by Tripy during one of the lowering passes. Notice that we are able to explain
exactly why the operation was inserted and which part of the user’s Python code
it originated from:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>--&gt;<span class="w"> </span>example.py:11<span class="w"> </span><span class="k">in</span><span class="w"> </span>main<span class="o">()</span>
<span class="w">    </span><span class="p">|</span>
<span class="m">11</span><span class="w">  </span><span class="p">|</span><span class="w">     </span>print<span class="o">(</span>add<span class="o">(</span>a,<span class="w"> </span>b<span class="o">))</span>
<span class="w">    </span><span class="p">|</span>

InternalError:<span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span>run<span class="w"> </span>compilation<span class="w"> </span>pipeline.
<span class="w">    </span><span class="o">(</span>t2<span class="o">)</span>error:<span class="w"> </span>size<span class="w"> </span>of<span class="w"> </span>operand<span class="w"> </span>dimension<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span><span class="m">3</span><span class="o">)</span><span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>compatible<span class="w"> </span>with<span class="w"> </span>size<span class="w"> </span>of<span class="w"> </span>result<span class="w"> </span>dimension<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span><span class="m">4</span><span class="o">)</span>

<span class="w">    </span>This<span class="w"> </span>error<span class="w"> </span>occured<span class="w"> </span><span class="k">while</span><span class="w"> </span>trying<span class="w"> </span>to<span class="w"> </span>compile<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>FlatIR<span class="w"> </span>expression:
<span class="w">        </span><span class="p">|</span>
<span class="w">        </span><span class="p">|</span><span class="w"> </span>t_inter11:<span class="w"> </span><span class="o">[</span><span class="nv">shape</span><span class="o">=(</span><span class="m">3</span>,<span class="w"> </span><span class="m">4</span>,<span class="o">)</span>,<span class="w"> </span><span class="nv">dtype</span><span class="o">=(</span>float32<span class="o">)</span>,<span class="w"> </span><span class="nv">loc</span><span class="o">=(</span>gpu:0<span class="o">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>DynamicBroadcastOp<span class="o">(</span>t1,<span class="w"> </span>t_inter8,<span class="w"> </span><span class="nv">broadcast_dim</span><span class="o">=[</span><span class="m">0</span>,<span class="w"> </span><span class="m">1</span><span class="o">])</span>
<span class="w">        </span><span class="p">|</span>

<span class="w">    </span>Note:<span class="w"> </span>Tripy<span class="w"> </span>introduced<span class="w"> </span>new<span class="w"> </span>operation<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>order<span class="w"> </span>to<span class="w"> </span>broadcast<span class="w"> </span>the<span class="w"> </span>inputs<span class="w"> </span>of<span class="w"> </span><span class="s1">&#39;+&#39;</span><span class="w"> </span>to<span class="w"> </span>compatible<span class="w"> </span>shapes.
<span class="w">    </span>This<span class="w"> </span>operation<span class="w"> </span>was<span class="w"> </span>introduced<span class="w"> </span>to<span class="w"> </span>broadcast<span class="w"> </span>the<span class="w"> </span>right<span class="w"> </span>operand,<span class="w"> </span>which<span class="w"> </span>was:
<span class="w">    </span>t1:<span class="w"> </span><span class="o">[</span><span class="nv">shape</span><span class="o">=(</span><span class="m">3</span>,<span class="w"> </span><span class="m">3</span>,<span class="o">)</span>,<span class="w"> </span><span class="nv">dtype</span><span class="o">=(</span>float32<span class="o">)</span>,<span class="w"> </span><span class="nv">loc</span><span class="o">=(</span>gpu:0<span class="o">)]</span><span class="w"> </span>to<span class="w"> </span>a<span class="w"> </span>shape<span class="w"> </span>of:<span class="w"> </span><span class="o">(</span><span class="m">3</span>,<span class="w"> </span><span class="m">4</span><span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>order<span class="w"> </span>to<span class="w"> </span>be<span class="w"> </span>compatible<span class="w"> </span>with<span class="w"> </span>the<span class="w"> </span>other<span class="w"> </span>input<span class="o">(</span>s<span class="o">)</span>.

<span class="w">    </span>Note:<span class="w"> </span>This<span class="w"> </span>originated<span class="w"> </span>from<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>expression:

<span class="w">    </span>--&gt;<span class="w"> </span>example.py:5<span class="w"> </span><span class="k">in</span><span class="w"> </span>add<span class="o">()</span>
<span class="w">        </span><span class="p">|</span>
<span class="w">    </span><span class="m">5</span><span class="w">   </span><span class="p">|</span><span class="w">     </span><span class="k">return</span><span class="w"> </span>a<span class="w"> </span>+<span class="w"> </span>b
<span class="w">        </span><span class="p">|</span><span class="w">            </span>^^^^^

<span class="w">    </span>Input<span class="w"> </span><span class="m">0</span>:

<span class="w">    </span>--&gt;<span class="w"> </span>example.py:9<span class="w"> </span><span class="k">in</span><span class="w"> </span>main<span class="o">()</span>
<span class="w">        </span><span class="p">|</span>
<span class="w">    </span><span class="m">9</span><span class="w">   </span><span class="p">|</span><span class="w">     </span><span class="nv">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tp.ones<span class="o">((</span><span class="m">3</span>,<span class="w"> </span><span class="m">4</span><span class="o">))</span>
<span class="w">        </span><span class="p">|</span><span class="w">         </span>^^^^^^^^^^^^^^^

<span class="w">    </span>Input<span class="w"> </span><span class="m">1</span>:

<span class="w">    </span>--&gt;<span class="w"> </span>example.py:10<span class="w"> </span><span class="k">in</span><span class="w"> </span>main<span class="o">()</span>
<span class="w">        </span><span class="p">|</span>
<span class="w">    </span><span class="m">10</span><span class="w">  </span><span class="p">|</span><span class="w">     </span><span class="nv">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tp.ones<span class="o">((</span><span class="m">3</span>,<span class="w"> </span><span class="m">3</span><span class="o">))</span>
<span class="w">        </span><span class="p">|</span><span class="w">         </span>^^^^^^^^^^^^^^^
</pre></div>
</div>
</li>
</ol>
</section>
</section>

</article>
        
          <aside class="nftt-toc">
            <div class="mt-3 mb-1 my-lg-0 ps-xl-3 text-muted">
              <button class="btn btn-link link-dark p-md-0 mb-2 mb-md-0 text-decoration-none nftt-toc-toggle d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#tocContents" aria-expanded="false" aria-controls="tocContents"
              >On this page <i class="ms-2 bi bi-chevron-expand"></i></button>
              <div class="title d-none d-md-block">
                <i class="bi bi-file-earmark-text"></i>&nbsp;&nbsp;<span class="small">On this page</span>
              </div>
              <hr class="d-none d-md-block my-2">
              <div class="collapse nftt-toc-collapse" id="tocContents">
                <nav id="TableOfContents">
                  <ul>
<li><a class="reference internal" href="#">Design Decisions</a><ul>
<li><a class="reference internal" href="#no-api-redundancy">No API Redundancy</a></li>
<li><a class="reference internal" href="#why-flatir">Why <code class="docutils literal notranslate"><span class="pre">FlatIR</span></code>?</a></li>
<li><a class="reference internal" href="#why-does-to-flat-ir-rely-on-binding-to-input-output-tensors">Why Does <code class="docutils literal notranslate"><span class="pre">to_flat_ir()</span></code> Rely On Binding To Input/Output Tensors?</a><ul>
<li><a class="reference internal" href="#alternative-1-returning-operators">Alternative 1: Returning Operators</a></li>
<li><a class="reference internal" href="#alternative-2-functional-apis">Alternative 2: Functional APIs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#why-is-baseflatirop-to-mlir-asymmetric-with-basetraceop-to-flat-ir">Why Is <code class="docutils literal notranslate"><span class="pre">BaseFlatIROp.to_mlir()</span></code> Asymmetric With <code class="docutils literal notranslate"><span class="pre">BaseTraceOp.to_flat_ir()</span></code>?</a></li>
<li><a class="reference internal" href="#why-not-build-on-jax">Why Not Build On JAX?</a></li>
</ul>
</li>
</ul>

                </nav>
              </div>
            </div>
          </aside>
        
      </main>
    </div>

    <footer class="nftt-footer">
      
<nav id="paginator"></nav>

      <div class="py-5 px-4 px-md-3">
  <div class="container">
    

    <div class="row">
      <div class="col-lg-12 text-center">
        <a class="brand-text d-inline-flex align-items-center mb-2 text-decoration-none" href="/" aria-label="Nefertiti-for-Sphinx">
          <span class="fs-6 fw-bold">Tripy</span>
        </a>
        
          <ul class="list-unstyled small text-muted">
            <li>2024, NVIDIA</li>
          </ul>
        
        
      </div>
    </div>
  </div>
</div>
    </footer>
    <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>

    <script type="text/javascript" src="../../_static/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="../../_static/sphinx-nefertiti.min.js"></script>
    
  </body>
</html>