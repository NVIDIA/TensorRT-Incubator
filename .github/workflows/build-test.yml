name: MLIR-TensorRT Build and Test

on:
  workflow_call:
    inputs:
      channel:
        description: 'Channel to build and test, defaults to "test"'
        default: "test"
        type: string
      build-matrix:
        description: 'Build matrix to utilize'
        default: ""
        type: string

jobs:
  mlir-tensorrt-build-test:
    name: build-test-${{ matrix.arch }}-${{ matrix.cuda }}-trt${{ matrix.trt }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(inputs.build-matrix) }}
    env:
      CU_VERSION: ${{ matrix.cuda }}
      TRT_VERSION: ${{ matrix.trt }}
      CHANNEL: ${{ inputs.channel }}
    runs-on: ${{ matrix.runner }}
    container:
      image: ${{ matrix.docker_image }}
      options: '--gpus all'
    steps:
      - name: checkout TensorRT-Incubator
        uses: actions/checkout@v4
      - name: python format and clang check
        run: |
          #set -euo pipefail
          set -x
          python3 -m pip install black
          python3 -m black --check --extend-exclude='.*\.pyi' mlir-tensorrt/compiler/
          python3 -m black --check --extend-exclude='.*\.pyi' mlir-tensorrt/integrations/python/
      - name: create cache folder
        run: |
          #set -euo pipefail
          set -x
          mkdir -p ${{ github.workspace }}/ccache
          mkdir -p ${{ github.workspace }}/.cache.cpm
      - name: restore cache
        uses: actions/cache/restore@v4
        with:
          key: ${{ runner.os }}-mlir-tensorrt-cache-${{ hashFiles('mlir-tensorrt/**/*.cpp', 'mlir-tensorrt/**/*.h', 'mlir-tensorrt/build_tools/**/*') }}
          restore-keys: |
            ${{ runner.os }}-mlir-tensorrt-cache-
          path: |
            ${{ github.workspace }}/ccache
            ${{ github.workspace }}/.cache.cpm/*
            !${{ github.workspace }}/.cache.cpm/tensorrt
      - name: build_${{ matrix.cuda }}_trt${{ matrix.trt }}
        run: |
          #set -euo pipefail
          set -x
          cd mlir-tensorrt
          # build and testings
          DOWNLOAD_TENSORRT_VERSION=${{ matrix.trt }} ./build_tools/scripts/cicd_build.sh --build_only
      - name: save cache
        uses: actions/cache/save@v4
        with:
          key: ${{ runner.os }}-mlir-tensorrt-cache-${{ hashFiles('mlir-tensorrt/**/*.cpp', 'mlir-tensorrt/**/*.h', 'mlir-tensorrt/build_tools/**/*') }}
          path: |
            ${{ github.workspace }}/ccache
            ${{ github.workspace }}/.cache.cpm/*
            !${{ github.workspace }}/.cache.cpm/tensorrt
      - name: test_${{ matrix.cuda }}_trt${{ matrix.trt }}
        run: |
          #set -euo pipefail
          set -x
          cd mlir-tensorrt
          DOWNLOAD_TENSORRT_VERSION=${{ matrix.trt }} ./build_tools/scripts/cicd_build.sh
      - name: ASAN_test_${{ matrix.cuda }}_trt${{ matrix.trt }}
        run: |
          #set -euo pipefail
          set -x
          cd mlir-tensorrt
          DOWNLOAD_TENSORRT_VERSION=${{ matrix.trt }} ENABLE_ASAN=ON ./build_tools/scripts/cicd_build.sh
      - name: build_wheel_${{ matrix.cuda }}_trt${{ matrix.trt }}
        run: |
          #set -euo pipefail
          set -x
          cd mlir-tensorrt
          DOWNLOAD_TENSORRT_VERSION=${{ matrix.trt }} ./build_tools/scripts/cicd_build_wheels.sh --build_wheels
      - name: smoke_test_wheel_${{ matrix.cuda }}_trt${{ matrix.trt }}
        run: |
          #set -euo pipefail
          set -x
          cd mlir-tensorrt
          python3 -m pip install .private.wheels/mlir_tensorrt-*.whl
          # TODO: add smoke test for the wheel

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref_name }}-tensorrt-${{ inputs.channel }}
  cancel-in-progress: true