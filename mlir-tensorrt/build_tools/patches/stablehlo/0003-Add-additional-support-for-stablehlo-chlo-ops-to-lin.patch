From b9c6d21073a89887ea61c200a91596e3c9d7ce79 Mon Sep 17 00:00:00 2001
From: Christopher Bate <cbate@nvidia.com>
Date: Wed, 23 Jul 2025 22:37:48 +0000
Subject: [PATCH 3/4] Add additional support for stablehlo & chlo ops to linalg
 pointwise conversion

---
 .../linalg/transforms/MapStablehloToScalarOp.h    | 15 ++++++++++++++-
 .../transforms/StablehloToLinalgPointwise.cpp     |  7 ++++++-
 2 files changed, 20 insertions(+), 2 deletions(-)

diff --git a/stablehlo/conversions/linalg/transforms/MapStablehloToScalarOp.h b/stablehlo/conversions/linalg/transforms/MapStablehloToScalarOp.h
index 01cfa237..2cf82769 100644
--- a/stablehlo/conversions/linalg/transforms/MapStablehloToScalarOp.h
+++ b/stablehlo/conversions/linalg/transforms/MapStablehloToScalarOp.h
@@ -30,6 +30,7 @@ limitations under the License.
 #include "mlir/IR/BuiltinTypes.h"
 #include "mlir/IR/ImplicitLocOpBuilder.h"
 #include "mlir/IR/TypeUtilities.h"
+#include "stablehlo/dialect/ChloOps.h"
 #include "stablehlo/dialect/StablehloOps.h"
 
 namespace mlir {
@@ -153,16 +154,18 @@ struct StablehloToScalarOp<stablehlo::SineOp> {
   using FOp = ::mlir::math::SinOp;
   using COp = ::mlir::complex::SinOp;
 };
+
 template <>
 struct StablehloToScalarOp<stablehlo::TanOp> {
   using FOp = ::mlir::math::TanOp;
   using COp = ::mlir::complex::TanOp;
 };
+
 template <>
 struct StablehloToScalarOp<stablehlo::Atan2Op> {
-  using FOp = ::mlir::math::Atan2Op;
   using COp = ::mlir::complex::Atan2Op;
 };
+
 template <>
 struct StablehloToScalarOp<stablehlo::TanhOp> {
   using FOp = ::mlir::math::TanhOp;
@@ -174,6 +177,16 @@ struct StablehloToScalarOp<stablehlo::XorOp> {
   using UOp = ::mlir::arith::XOrIOp;
 };
 
+template <>
+struct StablehloToScalarOp<chlo::ErfOp> {
+  using FOp = ::mlir::math::ErfOp;
+};
+
+template <>
+struct StablehloToScalarOp<chlo::ErfcOp> {
+  using FOp = ::mlir::math::ErfcOp;
+};
+
 // Alias for the map from StableHLO binary op type to STD floating-point op
 // type.
 template <typename StablehloOp>
diff --git a/stablehlo/conversions/linalg/transforms/StablehloToLinalgPointwise.cpp b/stablehlo/conversions/linalg/transforms/StablehloToLinalgPointwise.cpp
index 4f689f79..4c1a9ace 100644
--- a/stablehlo/conversions/linalg/transforms/StablehloToLinalgPointwise.cpp
+++ b/stablehlo/conversions/linalg/transforms/StablehloToLinalgPointwise.cpp
@@ -42,6 +42,7 @@ limitations under the License.
 #include "stablehlo/conversions/linalg/transforms/LegalizeToLinalgUtils.h"
 #include "stablehlo/conversions/linalg/transforms/MapStablehloToScalarOp.h"
 #include "stablehlo/conversions/linalg/transforms/Rewriters.h"
+#include "stablehlo/dialect/ChloOps.h"
 #include "stablehlo/dialect/StablehloOps.h"
 
 #define DEBUG_TYPE "stablehlo-conversions"
@@ -271,6 +272,8 @@ void populatePointwiseStablehloToLinalgConversionPatterns(
     bool captureScalarInputs) {
   if (enablePrimitiveOps) {
     patterns->add<
+        PointwiseToLinalgMapConverter<mlir::chlo::ErfOp>,
+        PointwiseToLinalgMapConverter<mlir::chlo::ErfcOp>,
         PointwiseToLinalgMapConverter<mlir::stablehlo::AbsOp>,
         PointwiseToLinalgMapConverter<mlir::stablehlo::AddOp>,
         PointwiseToLinalgMapConverter<mlir::stablehlo::AndOp>,
@@ -322,7 +325,9 @@ void populatePointwiseStablehloToLinalgConversionPatterns(
     return;
   }
   patterns
-      ->add<PointwiseToLinalgConverter<mlir::stablehlo::AbsOp>,
+      ->add<PointwiseToLinalgConverter<mlir::chlo::ErfOp>,
+            PointwiseToLinalgConverter<mlir::chlo::ErfcOp>,
+            PointwiseToLinalgConverter<mlir::stablehlo::AbsOp>,
             PointwiseToLinalgConverter<mlir::stablehlo::AddOp>,
             PointwiseToLinalgConverter<mlir::stablehlo::AndOp>,
             PointwiseToLinalgConverter<mlir::stablehlo::Atan2Op>,
-- 
2.52.0

