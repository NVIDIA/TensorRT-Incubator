#include <cuda.h>
#include <cuda_runtime_api.h>

#include <cstdint>
#include <cstdio>

#include "MTRTRuntimeStatus.h"

extern CUstream cuda_launch_argpack_test_cuda_stream[3];

// Aggregated init/destroy helpers generated by the EmitC host backend.
int32_t cuda_launch_argpack_test_initialize_all();
void cuda_launch_argpack_test_destroy_all();

int32_t run();

int main() {
  // The generated code reads the stream from a global.
  cuda_launch_argpack_test_cuda_stream[0] = cudaStreamDefault;
  cuda_launch_argpack_test_cuda_stream[1] = cudaStreamDefault;
  cuda_launch_argpack_test_cuda_stream[2] = cudaStreamDefault;

  int32_t initRc = cuda_launch_argpack_test_initialize_all();
  if (initRc != 0) {
    // Best-effort: runtime stores a thread-local message for the last error.
    std::fprintf(stderr, "%s\n", mtrt::get_last_error_message());
    return initRc;
  }

  int32_t rc = run();
  cudaStreamSynchronize(cuda_launch_argpack_test_cuda_stream[0]);

  cuda_launch_argpack_test_destroy_all();
  return rc;
}
